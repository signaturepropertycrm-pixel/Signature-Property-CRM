
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Custom claims checks
    function getRole() {
      return request.auth.token.role;
    }
    function isAdmin() {
      return isSignedIn() && getRole() == 'Admin';
    }
    function isEditor() {
      return isSignedIn() && getRole() == 'Editor';
    }
    function isAgent() {
      return isSignedIn() && getRole() == 'Agent';
    }

    // Agency membership check
    function isMemberOfAgency(agencyId) {
        return isSignedIn() && request.auth.token.agency_id == agencyId;
    }

    // MAIN RULES

    // /users/{userId}
    // This stores the primary profile for each user, including their role and agency affiliation.
    match /users/{userId} {
      // An Admin can create any user document (needed for adding team members).
      // A user can also create their own initial document upon signup.
      allow create: if isUser(userId) || isAdmin();
      
      // A user can get their own document.
      // An admin can get any user document.
      allow get: if isUser(userId) || isAdmin();
      
      // A user can update their own document.
      // An admin can update any user document.
      allow update: if isUser(userId) || isAdmin();
      
      // Nobody can list all users.
      allow list: if false;
      // Only an Admin can delete a user document.
      allow delete: if isAdmin();

      // TeamMembers Subcollection:
      // - Any member of the agency can read the list of team members (for charts, etc.).
      // - Only the Admin (owner) of the agency can write (add/edit/delete) team members.
      match /teamMembers/{memberId} {
        allow read: if isMemberOfAgency(userId);
        allow write: if isUser(userId) && isAdmin();
      }
    }
    
    // Role documents for easy rule checking
    match /roles_admin/{uid} {
        allow read, write: if isAdmin();
    }
    match /roles_editor/{uid} {
        allow read, write: if isAdmin();
    }
    match /roles_agent/{uid} {
        allow read, write: if isAdmin();
    }

    // /properties/{propertyId}
    match /properties/{propertyId} {
      // Any member of the agency can read properties.
      allow read: if isMemberOfAgency(resource.data.agency_id);
      
      // Only Admins or Editors can create properties.
      allow create: if (isAdmin() || isEditor()) && isMemberOfAgency(request.resource.data.agency_id);

      // Only Admins or Editors can update properties.
      allow update: if (isAdmin() || isEditor()) && isMemberOfAgency(resource.data.agency_id);

      // Only Admins or Editors can delete properties.
      allow delete: if (isAdmin() || isEditor()) && isMemberOfAgency(resource.data.agency_id);
    }

    // /buyers/{buyerId}
    match /buyers/{buyerId} {
      // Any member of the agency can read buyer documents.
      allow read: if isMemberOfAgency(resource.data.agency_id);
      
      // Any agency member can create a new buyer.
      allow create: if isMemberOfAgency(request.resource.data.agency_id);

      // Admins and Editors can fully update. Agents can ONLY update 'status' and 'last_follow_up_note'.
      allow update: if (isAdmin() || isEditor()) && isMemberOfAgency(resource.data.agency_id);
      allow update: if isAgent() && isMemberOfAgency(resource.data.agency_id) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'last_follow_up_note']);

      // Only Admins or Editors can delete buyers.
      allow delete: if (isAdmin() || isEditor()) && isMemberOfAgency(resource.data.agency_id);
    }
    
    // /appointments/{appointmentId}, /followUps/{followUpId}, /activityLogs/{activityLogId}
    // All agency members can read and write to these collections.
    match /{collectionName}/{docId}
    where collectionName in ['appointments', 'followUps', 'activityLogs'] {
       allow read, write: if isSignedIn() && (
            (request.method == 'create' && isMemberOfAgency(request.resource.data.agency_id)) ||
            (request.method != 'create' && isMemberOfAgency(resource.data.agency_id))
        );
    }
    
    // Admin-only collections
    match /transactions/{transactionId} {
      allow read, write: if isAdmin();
    }
  }
}
