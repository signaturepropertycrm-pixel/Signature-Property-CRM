
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    // =================================
    // Collection Rules
    // =================================

    /**
     * Rules for the /users collection.
     * - A user can read/write their own profile.
     * - A user document can only be created if the user is creating their own record.
     */
    match /users/{userId} {
      allow read, update, delete: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Rules for the /agencies collection and its sub-collections.
     * This is the main data container for each agency.
     */
    match /agencies/{agencyId} {
      // Agency-level document access
      allow read, write: if isSignedIn() && request.auth.uid == resource.data.ownerId;

      /**
       * Generic rule for sub-collections within an agency.
       * Access is granted based on the `agency_id` stored within a user's own profile.
       * This requires a client-side fetch to get the user's profile first, but simplifies rules.
       *
       * This rule is NOT USED directly, but explains the logic. The specific sub-collection
       * rules below are what grant access.
       */
      function isMemberOfRequestingAgency(uid) {
        return get(/databases/$(database)/documents/users/$(uid)).data.agency_id == agencyId;
      }
      
      function userRole(uid) {
        return get(/databases/$(database)/documents/users/$(uid)).data.role;
      }

      /**
       * Sub-collection rules for properties.
       * - Any member of the agency can read properties.
       * - Only Admins or Editors of the agency can write (create, update, delete).
       */
      match /properties/{propertyId} {
        allow read: if isMemberOfRequestingAgency(request.auth.uid);
        allow write: if isMemberOfRequestingAgency(request.auth.uid) && (userRole(request.auth.uid) == 'Admin' || userRole(request.auth.uid) == 'Editor');
      }

      /**
       * Sub-collection rules for buyers.
       * - Any agency member can read/create buyers.
       * - Admins/Editors can update/delete any buyer.
       * - Agents can only update status/notes.
       */
      match /buyers/{buyerId} {
        allow read, create: if isMemberOfRequestingAgency(request.auth.uid);
        allow update: if (isMemberOfRequestingAgency(request.auth.uid) && (userRole(request.auth.uid) == 'Admin' || userRole(request.auth.uid) == 'Editor'))
                      || (isMemberOfRequestingAgency(request.auth.uid) && userRole(request.auth.uid) == 'Agent' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'last_follow_up_note']));
        allow delete: if isMemberOfRequestingAgency(request.auth.uid) && (userRole(request.auth.uid) == 'Admin' || userRole(request.auth.uid) == 'Editor');
      }

      /**
       * Sub-collection rules for appointments, follow-ups, and activities.
       * - All agency members can read and create these records.
       * - Full write access is given to agency members for simplicity.
       */
      match /appointments/{appointmentId} {
        allow read, write: if isMemberOfRequestingAgency(request.auth.uid);
      }

      match /followUps/{followUpId} {
        allow read, write: if isMemberOfRequestingAgency(request.auth.uid);
      }
      
      match /activityLogs/{activityLogId} {
        allow read: if isMemberOfRequestingAgency(request.auth.uid) && (userRole(request.auth.uid) == 'Admin' || userRole(request.auth.uid) == 'Editor');
        allow create: if isMemberOfRequestingAgency(request.auth.uid);
        allow update, delete: if false;
      }

      /**
       * Sub-collection rules for team members.
       * - Only an Admin of the agency can read or write to the team members list.
       */
      match /teamMembers/{memberId} {
        allow read, write: if isMemberOfRequestingAgency(request.auth.uid) && userRole(request.auth.uid) == 'Admin';
      }
    }
  }
}
