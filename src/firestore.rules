
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Retrieves the user's profile data from the /users collection.
     * This is a critical function for checking roles and agency affiliation.
     * @param userId The UID of the user whose data is to be fetched.
     * @returns The user's document data.
     */
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    /**
     * Checks if the currently authenticated user belongs to the specified agency.
     * @param agencyId The ID of the agency to check against.
     * @returns True if the user's agency_id matches the provided agencyId.
     */
    function isAgencyMember(agencyId) {
      return isSignedIn() && getUserData(request.auth.uid).agency_id == agencyId;
    }

    /**
     * Checks if the currently authenticated user has a specific role.
     * @param role The role to check for (e.g., 'Admin', 'Editor', 'Agent').
     * @returns True if the user has the specified role.
     */
    function isRole(role) {
        return isSignedIn() && getUserData(request.auth.uid).role == role;
    }

    /**
     * Checks if the user is an Admin of the specified agency.
     */
    function isAdminOfAgency(agencyId) {
        return isAgencyMember(agencyId) && isRole('Admin');
    }

    /**
     * Checks if the user is an Editor or Admin of the specified agency.
     */
    function isEditorOfAgency(agencyId) {
        return isAgencyMember(agencyId) && (isRole('Admin') || isRole('Editor'));
    }

    // =================================
    // Collection Rules
    // =================================

    /**
     * Rules for the /users collection.
     * - A user can read their own profile.
     * - An Admin can read the profiles of users within their own agency.
     * - A new user can be created upon signup.
     * - An Admin can update user roles within their agency, and users can update their own non-critical info.
     * - Only an Admin can delete users from their agency.
     */
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdminOfAgency(getUserData(userId).agency_id));
      allow create: if isSignedIn(); // Allows user creation on signup.
      allow update: if request.auth.uid == userId || isAdminOfAgency(resource.data.agency_id);
      allow delete: if isAdminOfAgency(resource.data.agency_id);
    }

    /**
     * Rules for the /agencies collection and its sub-collections.
     * This is the main data container for each agency.
     */
    match /agencies/{agencyId} {
      // Agency-level document access (if any)
      allow read, write: if isAdminOfAgency(agencyId);

      /**
       * Sub-collection rules for properties.
       * - Any agency member can read/list properties.
       * - Only Admins or Editors can create, update, or delete properties.
       */
      match /properties/{propertyId} {
        allow read: if isAgencyMember(agencyId);
        allow write: if isEditorOfAgency(agencyId);
      }

      /**
       * Sub-collection rules for buyers.
       * - Any agency member can read/list buyers.
       * - Any agency member can create a buyer.
       * - Only Admins or Editors can fully update/delete buyers.
       * - Agents can update only the status.
       */
      match /buyers/{buyerId} {
        allow read: if isAgencyMember(agencyId);
        allow create: if isAgencyMember(agencyId);
        // Admin and Editor can update anything
        allow update: if isEditorOfAgency(agencyId);
        // Agent can only update status and last_follow_up_note
        allow update: if isAgencyMember(agencyId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'last_follow_up_note']);
        allow delete: if isEditorOfAgency(agencyId);
      }

      /**
       * Sub-collection rules for appointments.
       * - All agency members can read and create appointments.
       * - Any member can update or delete THEIR OWN appointments (e.g. agent assigned to it).
       * - Admin/Editor can manage ALL appointments.
       */
      match /appointments/{appointmentId} {
        allow read, create: if isAgencyMember(agencyId);
        allow update, delete: if isEditorOfAgency(agencyId) || (isAgencyMember(agencyId) && resource.data.agentName == getUserData(request.auth.uid).name);
      }

      /**
       * Sub-collection rules for follow-ups.
       * - All agency members can read and write follow-ups.
       */
      match /followUps/{followUpId} {
        allow read, write: if isAgencyMember(agencyId);
      }

       /**
       * Sub-collection rules for team members.
       * - Only Admins can manage their team.
       */
      match /teamMembers/{memberId} {
        allow read, write: if isAdminOfAgency(agencyId);
      }

      /**
       * Sub-collection for activity logs.
       * - Only Admins and Editors can view logs.
       * - Any member can create a log entry (as they perform actions).
       */
      match /activityLogs/{activityLogId} {
        allow read: if isEditorOfAgency(agencyId);
        allow create: if isAgencyMember(agencyId);
        allow update, delete: if false;
      }
    }
  }
}
